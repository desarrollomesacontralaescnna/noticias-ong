<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Noticias ONG</title>
  <style>
    body{font-family:Arial;max-width:900px;margin:20px auto;padding:20px;background:#fff}
    .card{display:flex;gap:20px;border:1px solid #ddd;padding:12px;border-radius:8px;margin-bottom:12px;align-items:center;}
    .card img{width:100px;height:100px;object-fit:cover;border-radius:6px;}
    .card-content{flex:1;}
    .card-content p{color:#555;font-size:0.9em;}
    button{padding:8px 12px;border-radius:6px;border:none;background:#0077cc;color:#fff;cursor:pointer;margin-right:8px;}
    .danger{background:#d9534f}
  </style>
</head>
<body>
  <h1>üì∞ Noticias ONG</h1>
  <button onclick="location.href='editor.html'">‚ûï Crear noticia</button>
  <div id="list"></div>

<script>
  // CONFIG (cambiar con tus datos)
  const OWNER = "desarrollomesacontralaescnna";
  const REPO = "noticias-ong";
  const BRANCH = "main";
  // CAMBIO: URL del worker para la funci√≥n de eliminar
  const WORKER_URL = "https://noticias-ong-api.desarrollomesacontralaescnna.workers.dev/delete-file";

    async function load() {
    const listEl = document.getElementById('list');
    listEl.innerHTML = '<p>Cargando...</p>';
    
    try {
      const cacheBuster = '?cache=' + new Date().getTime();
      
      // --- PASO 1: Cargar noticias publicadas (como antes) ---
      const resp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/noticias`, {
        cache: 'no-cache', // <-- A√ëADE ESTO
        headers: { 'Accept': 'application/vnd.github.v3+json' }
    });
      if (!noticiasResp.ok) throw new Error('Error al pedir noticias: ' + noticiasResp.status);
      const noticiasFiles = await noticiasResp.json();

      // --- PASO 2: Cargar drafts pendientes ---
      let draftsFiles = [];
      try {
        const draftsResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/drafts${cacheBuster}`, {
          headers: { 'Accept': 'application/vnd.github.v3+json' }
        });
        if (draftsResp.ok) {
          draftsFiles = await draftsResp.json();
        }
      } catch(e) { console.warn("No se pudo cargar la carpeta de drafts (puede que no exista):", e); }

      listEl.innerHTML = '';
      
      // --- PASO 3: Renderizar los drafts primero ---
      if (draftsFiles.length > 0) {
        const draftsHeader = document.createElement('h2');
        draftsHeader.textContent = 'Pendientes de Publicaci√≥n ‚è≥';
        draftsHeader.style.opacity = '0.7';
        listEl.appendChild(draftsHeader);

        for (const f of draftsFiles.sort((a,b) => b.name.localeCompare(a.name))) {
          if (!f.name.endsWith('.json')) continue;
          const draftData = JSON.parse(atob( (await (await fetch(f.url + cacheBuster)).json()).content ));
          const slug = f.name.replace('.json','');
          const card = document.createElement('div');
          card.className = 'card';
          card.style.opacity = '0.6';
          card.id = `card-draft-${slug}`;
          card.innerHTML = `
            <div class="card-content">
              <h3>${draftData.title}</h3>
              <small>${draftData.date}</small>
              <p><i>Procesando... La noticia aparecer√° publicada en unos minutos.</i></p>
              <div style="margin-top:8px">
                <button disabled>‚úèÔ∏è Editar</button>
                <button disabled class="danger">üóëÔ∏è Eliminar</button>
              </div>
            </div>`;
          listEl.appendChild(card);
        }
      }

      // --- PASO 4: Renderizar las noticias publicadas ---
      if (noticiasFiles.length > 0) {
        const noticiasHeader = document.createElement('h2');
        noticiasHeader.textContent = 'Publicaciones';
        listEl.appendChild(noticiasHeader);
        // ... (El resto del bucle for para las noticias publicadas se mantiene igual que antes)
        for (const f of noticiasFiles.sort((a,b) => b.name.localeCompare(a.name))) { 
          if (!f.name.endsWith('.md')) continue;
          const raw = await fetch(f.download_url + cacheBuster).then(r=>r.text());
          const match = /^---([\s\S]*?)---/.exec(raw);
          let title = f.name.replace('.md',''), date='', cover_image_url = '', markdown_preview = 'No hay contenido...';
          if (match) {
            const yaml = match[1];
            const mdContent = raw.replace(match[0], '').trim();
            title = /title:\s*"(.*?)"/.exec(yaml)?.[1] || title;
            date = /date:\s*"(.*?)"/.exec(yaml)?.[1] || '';
            const firstImage = /gallery:\s*\n\s*-\s*"(.*?)"/.exec(yaml)?.[1];
            if (firstImage) { cover_image_url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/images/${firstImage}`; }
            if (mdContent) { markdown_preview = mdContent.substring(0, 50).replace(/(\r\n|\n|\r)/gm, " ") + '...'; }
          }
          const slug = f.name.replace('.md','');
          const card = document.createElement('div');
          card.className = 'card';
          card.id = `card-${slug}`;
          card.innerHTML = `
            ${cover_image_url ? `<img src="${cover_image_url}" alt="Portada">` : ''}
            <div class="card-content">
              <h3>${title}</h3>
              <small>${date}</small>
              <p>${markdown_preview}</p>
              <div style="margin-top:8px">
                <button onclick="location.href='editor.html?slug=${slug}'">‚úèÔ∏è Editar</button>
                <button class="danger" onclick="deleteNoticia('${slug}')">üóëÔ∏è Eliminar</button>
              </div>
            </div>`;
          listEl.appendChild(card);
        }
      }
      
    } catch (e) {
      listEl.innerHTML = '<p>No se pudieron cargar noticias. ' + e.message + '</p>';
    }
  }

  // CAMBIO: Nueva funci√≥n para eliminar noticias
  async function deleteNoticia(slug) {
    if (!confirm(`¬øEst√°s seguro de que quieres eliminar la noticia "${slug}"? Esta acci√≥n no se puede deshacer.`)) {
      return;
    }
    if (!confirm(`CONFIRMACI√ìN FINAL: ¬øRealmente quieres eliminar "${slug}" de forma permanente?`)) {
      return;
    }

    try {
      const res = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          path: `noticias/${slug}.md`,
          message: `ci: eliminar noticia ${slug}`
        })
      });

      if (!res.ok) {
        throw new Error(await res.text());
      }
      
      alert(`Noticia "${slug}" eliminada con √©xito.`);
      // Eliminar la tarjeta de la vista sin recargar la p√°gina
      document.getElementById(`card-${slug}`).remove();

    } catch (e) {
      alert(`Error al eliminar la noticia: ${e.message}`);
    }
  }

  load();
</script>
</body>
</html>