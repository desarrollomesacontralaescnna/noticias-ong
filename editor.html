<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Editor - Noticias ONG</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <style>
    body{font-family:Arial;max-width:900px;margin:20px auto;padding:20px;background:#f7f7f7;border-radius:10px}
    input,button{width:100%;padding:10px;margin-bottom:12px}
    /* CAMBIO: Estilos para la galería de imágenes */
    .gallery-preview .img-container{position:relative;display:inline-block;margin:4px;}
    .gallery-preview img{max-height:80px;border-radius:6px;display:block;}
    .gallery-preview .delete-btn{position:absolute;top:-5px;right:-5px;background:red;color:white;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-weight:bold;line-height:20px;text-align:center;}
  </style>
</head>
<body>
  <h1>✏️ Editor de Noticias</h1>

  <label>Título</label>
  <input id="titulo" />

  <label>Fecha</label>
  <input id="fecha" type="date" />

  <label>Portada & Galería (sube nuevas imágenes aquí)</label>
  <input id="files" type="file" accept="image/*" multiple />
  <div id="preview" class="gallery-preview"></div>

  <label>Contenido</label>
  <div id="editor"></div>

  <button id="btnSave">Guardar Cambios</button>

  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <script>
    const WORKER_URL = "https://noticias-ong-api.desarrollomesacontralaescnna.workers.dev/create-draft";
    const OWNER = "desarrollomesacontralaescnna";
    const REPO = "noticias-ong";
    const BRANCH = "main";

    const editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '320px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical'
    });

    const filesInput = document.getElementById('files');
    const preview = document.getElementById('preview');
    let newFilesList = []; // Lista para los archivos NUEVOS que se suben
    // CAMBIO: Lista para los nombres de las imágenes EXISTENTES que se conservan
    let existingImages = []; 

    filesInput.addEventListener('change', (e) => {
      // Al subir nuevos archivos, los añadimos a la lista y a la preview
      newFilesList = newFilesList.concat(Array.from(e.target.files));
      renderGallery();
    });

    // CAMBIO: Función centralizada para renderizar la galería
    function renderGallery() {
      preview.innerHTML = '';
      
      // Renderizar imágenes existentes
      existingImages.forEach((imgName, index) => {
        const container = document.createElement('div');
        container.className = 'img-container';
        const imgUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/images/${imgName}`;
        container.innerHTML = `
          <img src="${imgUrl}" alt="${imgName}">
          <button class="delete-btn" onclick="removeExistingImage(${index})">&times;</button>
        `;
        preview.appendChild(container);
      });

      // Renderizar imágenes nuevas (recién subidas)
      newFilesList.forEach((file, index) => {
        const container = document.createElement('div');
        container.className = 'img-container';
        const url = URL.createObjectURL(file);
        container.innerHTML = `
          <img src="${url}" alt="${file.name}">
          <button class="delete-btn" onclick="removeNewImage(${index})">&times;</button>
        `;
        preview.appendChild(container);
      });
    }

    // CAMBIO: Funciones para eliminar imágenes
    function removeExistingImage(index) {
      existingImages.splice(index, 1); // La elimina de la lista de existentes
      renderGallery();
    }
    function removeNewImage(index) {
      newFilesList.splice(index, 1); // La elimina de la lista de nuevas
      renderGallery();
    }

    async function fileToBase64(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result.split(',')[1]);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');

    (async function preload() {
      if (!slug) return;
      document.getElementById('btnSave').textContent = `Guardar Cambios en "${slug}"`;
      try {
        const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/noticias/${slug}.md`;
        const resp = await fetch(rawUrl);
        if (!resp.ok) return;
        const raw = await resp.text();
        const match = /^---([\s\S]*?)---/.exec(raw);
        let md = raw;
        if (match) {
          const yaml = match[1];
          md = raw.replace(match[0], '').trim();
          document.getElementById('titulo').value = /title:\s*"(.*?)"/.exec(yaml)?.[1] || "";
          document.getElementById('fecha').value = /date:\s*"(.*?)"/.exec(yaml)?.[1] || "";
          
          // CAMBIO: Cargar imágenes existentes y renderizar la galería
          existingImages = [...yaml.matchAll(/- "(.*?)"/g)].map(m => m[1].split('/').pop()); // Tomamos solo el nombre del archivo
          renderGallery();
        }
        editor.setMarkdown(md);
      } catch (e) { console.warn(e); }
    })();

    document.getElementById('btnSave').addEventListener('click', async () => {
      const title = document.getElementById('titulo').value.trim();
      if (!title) { alert('Pon un título'); return; }
      const date = document.getElementById('fecha').value || new Date().toISOString().split('T')[0];
      const markdown = editor.getMarkdown();
      const slugFinal = slug || title.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');

      const draft = { title, date, slug: slugFinal, markdown };
      
      // CAMBIO: Construir la lista final de imágenes combinando existentes y nuevas
      const finalImages = [...existingImages]; // Empezamos con las existentes que no se borraron
      for (const f of newFilesList) {
        const b64 = await fileToBase64(f);
        // Las nuevas imágenes se envían con su contenido en base64
        finalImages.push({ nombre: f.name, contenido: b64 });
      }
      draft.images = finalImages;

      const res = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(draft)
      });

      if (!res.ok) {
        const txt = await res.text();
        alert("Error al enviar draft: " + res.status + " " + txt);
        return;
      }
      const j = await res.json();
      alert("Draft enviado: " + (j.slug || "ok") + ". En breve Actions lo procesará.");
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>